
JAL指令代表“跳转并链接”，是我们唯一使用J格式的指令。J格式有一个20位宽的立即数字段、一个目标寄存器字段和一个操作码字段。JAL指令对处理器状态进行了两次更新。首先，它将PC加4的值保存到目标寄存器中，以便保存返回地址。其次，它将程序计数器的新值设置为当前计数器的值加上偏移量，这个偏移量由立即数指定。

因此，JAL指令执行的是程序计数器相对跳转，跳转的范围由这20位的立即数决定。跳转的目标地址可以在±2的19次方范围内，位置以2字节为单位分开，这是为了支持压缩指令集。这意味着我们可以在-2的18次方到+2的18次方之间的32位字中跳转。

为了实现JAL指令，我们已经拥有了所有需要的硬件。我们只需要生成J型立即数。因此，如果你查看数据通路，你会发现我们实际上已经具备了一切所需的硬件。唯一的更新是立即数生成器需要能够生成J型立即数。J型立即数与B型立即数类似，我们只需添加一些多路复用器来选择最高的八个有效位。

在数据通路中，我们借用了JALR和分支指令的机制来实现JAL。首先，我们需要将PC加4的值保存到目标寄存器RD中。我们通过与JALR相同的机制实现这一点，将PC加4的值传送到回写选择多路复用器，回写选择设置为2，这样我们就可以将PC加4写入目标寄存器RD中。

第二个机制我们借用自分支指令。我们需要让ALU将输入A中的PC值与新生成的立即数相加，然后将结果返回给程序计数器。我们将PC选择信号始终设置为“取分支”，这样就完成了。

现在我们来看看JAL的数据通路。首先，我们获取指令，然后进行解码。我想强调几个点：我们将PC值发送到A选择多路复用器，同时将PC加4的值发送到回写选择多路复用器。当我们解码指令时，适当地设置控制位。与此同时，生成J型立即数，并将正确的操作数送到ALU中。ALU的输入多路复用器被设置为选择程序计数器和立即数，ALU的输出将被送回PC选择多路复用器。虽然PC选择多路复用器还有一个PC加4的输入，但它不会选择它，因为PC选择信号始终设置为“取分支”。

最后，我们使用回写选择多路复用器选择PC加4，并将其写回目标寄存器RD。在下一个时钟周期，目标寄存器和程序计数器将更新为新的值。这就是JAL指令的执行过程。
