RISC-V基础指令集包含六种指令类型，而U型指令是我们之前提到过的，它用于支持非常长的立即数，称为“高级立即数”。

U型指令的格式非常简单，它包含一个20位长的上部立即数，存储在指令的最高有效位，接着是目标寄存器字段和操作码。这个类型有两条指令：LUI（加载上部立即数）和AUIPC（将上部立即数加到程序计数器）。LUI指令将这20位的上部立即数加载到目标寄存器，并将低12位清零。AUIPC则将上部立即数与程序计数器相加，并将结果存储在目标寄存器rd中。

我们几乎已经有了所有需要的硬件，只需添加支持U型立即数的硬件。之前没有这种立即数处理，现在我们需要处理上部立即数的操作。这相对简单，我们只需要添加一个多路复用器，将这20位上部立即数送入立即数生成器，绕过其他类型的符号扩展等操作。

那么我们来确认一下，确保我们能够执行LUI和AUIPC指令。首先来看LUI指令的数据通路。我们会先通过将程序计数器指向指令存储器来获取指令。接着，程序计数器会递增，指向下一条指令。同时，这条指令会指向目标寄存器，并在寄存器文件中进行解码。这里不展示各种控制信号设置，因为我们已经知道如何适当地设置它们。接下来是立即数生成，所有需要做的就是确保这个立即数能够一路传递到目标寄存器rd。

我们将B选择设置为1，然后设置ALU，让它简单地将B值复制到它的输出。接着，将回写选择设置为1，这样我们就准备好将新数据写入目标寄存器rd。在下一个时钟周期，程序计数器将更新为PC加4，同时将上部立即数写入目标寄存器rd。

现在我们来看AUIPC指令的执行。首先我们获取指令，递增程序计数器，指向目标寄存器，生成立即数。同时我们要点亮这个路径，将程序计数器作为ALU的A输入，ALU的B输入则为立即数。我们将它们相加，选择回写选择器来选择这个结果，并将其写入目标寄存器。在下一个时钟周期，目标寄存器和程序计数器将更新为新的值。
