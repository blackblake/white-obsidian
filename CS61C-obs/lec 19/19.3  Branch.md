
**分支指令的作用是比较寄存器rs1和rs2的内容，根据分支条件来更新程序计数器。如果分支条件满足，程序计数器将更新为指定的偏移地址；如果不满足，则程序计数器增加4，跳到下一条指令。**

B型指令的 **立即数使用12位编码13位范围。最低位总是0** ，因为我们用2字节增量来表示-4096到+4094之间的值。现在来看一下当前的数据通路。我们有一个程序计数器PC，它目前只能更新为下一条指令的地址（增加4字节）。我们将做一些调整，使其支持基于分支结果的更新。

添加分支指令需要同时完成两件事：**分支条件计算和新地址的计算**。首先，状态变化不再通过修改寄存器或内存的内容实现，而是通过更改程序计数器的值。程序计数器的值在分支完成后有两种可能：要么是PC+4，要么是PC+立即数。

RISC-V有六种分支指令：beq、bne、blt、bge、bltu和bgeu，后两者是blt和bge的无符号版本。这些指令根据rs1和rs2的内容判断是否相等、不相等、小于、大于等于等。

由于我们只有一个ALU，我们需要添加额外的硬件。**新硬件应该用于计算PC加立即数，而不是执行比较。因此，我们将保持ALU的现有功能，并添加一个简单的比较器来进行分支条件的判断。**

![[Pasted image 20240909171247.png]]

这里是修改后的数据通路，主要增加了几个新组件。
- 首先，我们 **在PC前添加了一个多路复用器，允许我们选择PC+4或新地址** 。
- 接着，我们**增加了一个分支比较器，用于比较rs1和rs2的内容。比较器的输入包括是否为有符号比较，并输出两个单比特信号：是否相等或是否小于。** 
- 最后，我们**在ALU的A端输入前添加了一个多路复用器，允许我们选择rs1的内容或程序计数器。**

我们还需要生成新的立即数类型，这就是分支型立即数。此外，我们需要控制分支比较器，以确定是否为有符号或无符号比较。还需要控制ALU的输入复用器。

分支比较器的逻辑相对简单，只需要比较rs1和rs2的值。我们支持六种分支指令，但它们实际上只有两种结果：要么条件满足，要么不满足。通过对结果进行取反，我们可以从“小于”得到“大于等于”。

分支类型的立即数编码与S型非常相似。RISC-V将大部分立即数保存在与S型相同的位置，只需将一个立即数位移动到正确的位置即可。因此，我们只需使用一个两输入的多路复用器来调整位位置即可。

