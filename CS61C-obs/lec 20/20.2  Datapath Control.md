
我们已经设计了数据通路，现在是时候弄清楚如何设计控制单元来配置数据通路了。

请记住，我们之前讨论的处理器如何与内存协作。处理器内部有两个主要单元：数据通路和控制单元。控制单元其实就是我们已经讨论过的内容，只是我们还没有设计出来。现在我们看到的是数据通路的详细视图，而控制单元主要是图中底部的控制逻辑。

在数据通路中，我们有多个功能单元，比如程序计数器、固定加法器、指令内存、立即数生成单元、寄存器文件、分支比较器、算术逻辑单元（ALU）、数据内存，还有多个多路复用器，它们使得数据通路能够执行不同的指令。控制单元的作用是配置这些多路复用器以及数据通路中的其他选项，以便执行不同的指令。

为了理解这是如何完成的，让我们来看一些指令的执行过程，看看控制单元如何处理它们，同时了解处理器内部的多个计算或操作是如何并行执行的。我们可以通过回顾一些早期介绍的指令来做到这一点，看看这些指令如何在完整的数据通路中工作。

首先，我们来看看早期介绍的指令之一："存储字"（store word）。该指令从寄存器rs2中获取值，并将其写入由寄存器rs1中的基地址和立即数偏移指向的内存地址。

处理器内的每条指令都从时钟的上升沿开始执行。所以，在时钟的上升沿，我们会向程序计数器写入一个新值。这个新值会在程序计数器的输出端口出现，但需要一些时间，我们称之为 **【时钟到输出延迟】** 。经过时钟到输出延迟后，我们会在程序计数器输出端得到一个有效的地址，它指向指令内存，同时它也准备好被更新，并可能在数据通路的后续阶段中使用。

现在，让我们看看同时发生的事情。两个操作是并行进行的：我们从指令内存中获取指令，同时更新程序计数器。**当我们将加4操作应用到程序计数器时，我们得到的新值会出现在多路复用器的输入端。但在我们知道新指令的执行情况以及如何影响PC选择信号之前，该值不会通过多路复用器。** 

与此同时，我们已经从指令内存中获取了指令。当我们对程序计数器加4时，指令也已经从指令内存中获取完毕。需要注意的是，指令内存和固定加法器的传播延迟是可比的。我们曾经提到过，从内存获取数据就像去很远的地方（比如去萨克拉门托），而加法操作并不需要那么长时间。请记住，这里的指令内存是我们从主内存中提取的一小部分指令的本地副本，因此获取这些指令的时间与程序计数器的加法操作时间是相当的。

**一旦我们获取了指令，就可以同时进行多个操作。** 我们知道 **寄存器文件中不同寄存器的地址是固定的** ，因此即使这条指令不需要操作寄存器，提前获取数据也是没有代价的。我们可以稍后再决定是否需要使用这些数据。此外，我们可以并行生成立即数，不过立即数的生成会受到控制逻辑的影响。与此同时，我们还要确定指令类型并设置控制信号。

**控制逻辑本质上是多个布尔逻辑门，它们根据指令中的位来确定控制信号的值。** 对于这条"存储字"指令，PC选择信号会设置为加4。一旦确定了这一点，PC加4的值就会通过多路复用器传递到程序计数器的输入端。**但是在下一个时钟周期之前，该值不会被写入程序计数器。**

与此同时，我们也在从寄存器文件中获取数据，并 **生成立即数** 。立即数的生成可能比从寄存器获取数据稍微耗时一些，因为我们需要先确定使用哪种立即数格式，但这些操作的时间仍然是可比的。大约在同一时间，我们就能获得rs1、rs2的值和立即数，然后继续执行剩下的指令。

  **PS : 为什么要生成立即数？立即数难道不是已经在指令中被给出了吗？**
答：**立即数（immediate value）** 确实已经在指令中被给出，但是它是以**编码形式**存在于指令中，并不是直接以可以使用的数值形式存在。因此，在执行指令时，需要对这个立即数的编码进行处理，将其 **【提取和扩展】** 为一个可以用于运算或地址计算的实际数值。

接着，操作数会通过多路复用器传递，ALU会对两个值进行加法操作。此时，我们已经有了执行指令所需的所有信息。rs1加上偏移量会指向数据内存中的目标地址，而rs2中的值就是我们要写入的数据，准备好通过数据内存的写入端口写入内存。最后，我们只需要再一次提升时钟信号即可。

在这个时钟周期内，程序计数器和数据内存都会更新，从而完成这条指令。同时，我们也已经开始执行下一条指令。

让我们再快速看一下另一条早期介绍的指令："分支相等"（branch if equal）。它同样从时钟的上升沿开始执行。多项操作会并行进行：我们对程序计数器进行加4操作，但由于分支指令的结果尚未确定，因此此时加4后的新值 **不会立即写入程序计数器**。 

同时，我们会从寄存器中提取操作数，并生成立即数，同时解码指令以设置控制信号。此时，由于我们还不确定分支是否成立，所以PC选择信号还不能确定。我们会在ALU完成加法运算并得出新PC值后，再确定分支的方向。

当所有控制信号都设置完毕后，分支比较器会判断rs1和rs2是否相等，并相应地设置PC选择信号。根据分支的结果，程序计数器要么跳转到新的地址，要么继续顺序执行下一条指令。在时钟的下一个上升沿，程序计数器的值会被更新，从而完成这条分支指令的执行。